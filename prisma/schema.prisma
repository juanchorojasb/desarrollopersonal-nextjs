// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// üë§ MODELO DE USUARIO (Integrado con Clerk)
model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  firstName String?
  lastName  String?
  imageUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  subscriptions         Subscription[]
  paymentTransactions   PaymentTransaction[]
  qrPayments           QRPayment[]
  enrollments          Enrollment[]
  lessonProgress       LessonProgress[]
  workshopRegistrations WorkshopRegistration[]

  @@map("users")
}

// üí≥ MODELO DE PLANES
model Plan {
  id          String @id @default(cuid())
  name        String
  description String? @db.Text
  price       Int    // Precio en centavos (25000 = $25.000)
  currency    String @default("COP")
  
  // Caracter√≠sticas del plan
  billingCycle     String  // "MONTHLY", "QUARTERLY", "YEARLY"
  features         Json?   // Array de caracter√≠sticas
  maxCourses       Int?    // L√≠mite de cursos
  hasLiveSupport   Boolean @default(false)
  hasGroupCoaching Boolean @default(false)
  hasPrioritySupport Boolean @default(false)
  
  // Metadata
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  subscriptions Subscription[]

  @@map("plans")
}

// üì± MODELO DE SUSCRIPCIONES
model Subscription {
  id        String   @id @default(cuid())
  userId    String
  planId    String
  
  // Estado y facturaci√≥n
  status       String  // "PENDING", "ACTIVE", "CANCELLED", "EXPIRED"
  billingCycle String  // "MONTHLY", "QUARTERLY", "YEARLY"
  priceAmount  Int     // Precio pagado
  currency     String  @default("COP")
  
  // Per√≠odos de facturaci√≥n (OPCIONALES PARA EVITAR EL ERROR)
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  
  // Metadata
  isActive    Boolean  @default(true)
  cancelledAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan @relation(fields: [planId], references: [id])
  paymentTransactions PaymentTransaction[]

  @@map("subscriptions")
}

// üí∞ MODELO DE TRANSACCIONES PAYU
model PaymentTransaction {
  id              String   @id @default(cuid())
  userId          String
  subscriptionId  String?  // Referencia a la suscripci√≥n
  
  // Informaci√≥n del pago PayU
  referenceCode   String   @unique
  transactionId   String?
  amount          Int      // Monto en centavos
  currency        String   // "COP", "USD"
  country         String   // "CO", "EC"
  
  // Estado de la transacci√≥n
  status          String   // "PENDING", "APPROVED", "DECLINED", "ERROR"
  paymentMethod   String?  // M√©todo de pago usado
  
  // Datos PayU
  payuOrderId     String?
  payuTransactionId String?
  signature       String?
  
  // Metadata del pago
  description     String?  @db.Text
  extra1          String?  // userId
  extra2          String?  // planId
  extra3          String?  // billingCycle
  
  // Respuestas PayU
  responseCode    String?
  responseMessage String?
  
  // Timestamps
  processedAt     DateTime?
  confirmedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  @@map("payment_transactions")
}

// üí∞ MODELO DE PAGOS QR
model QRPayment {
  id          String   @id @default(cuid())
  userId      String
  planId      String
  
  // Informaci√≥n del pago
  amount      Int      // Monto en centavos
  currency    String   @default("COP")
  status      String   // "PENDING", "APPROVED", "REJECTED"
  
  // Datos bancarios usados
  bankName    String?  // "Bancolombia", "Davivienda"
  accountInfo String?  // Informaci√≥n de cuenta
  
  // Comprobante
  receiptUrl    String?  // URL del comprobante subido
  receiptFileName String?
  
  // Datos de aprobaci√≥n
  approvedBy    String?   // ID del admin que aprob√≥
  approvedAt    DateTime?
  rejectedAt    DateTime?
  rejectionReason String?
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("qr_payments")
}

// üìö MODELO DE CURSOS
model Course {
  id          String  @id @default(cuid())
  title       String
  slug        String? @unique // URL slug para acceso directo
  description String? @db.Text
  imageUrl    String?
  
  // Configuraci√≥n del curso
  isActive    Boolean @default(true)
  isFree      Boolean @default(false)
  sortOrder   Int     @default(0)
  duration    Int?    // Duraci√≥n estimada en minutos
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  modules     Module[]
  enrollments Enrollment[]

  @@map("courses")
}

// üìñ MODELO DE M√ìDULOS
model Module {
  id        String  @id @default(cuid())
  courseId  String
  title     String
  description String? @db.Text
  
  // Configuraci√≥n
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@map("modules")
}

// üé• MODELO DE LECCIONES
model Lesson {
  id       String  @id @default(cuid())
  moduleId String
  title    String
  content  String? @db.Text // Contenido de texto
  
  // Video MediaDelivery
  videoId       String? // ID del video en MediaDelivery
  videoUrl      String? // URL completa del iframe
  videoDuration Int?    // Duraci√≥n en segundos
  thumbnailUrl  String?
  
  // Configuraci√≥n
  sortOrder Int     @default(0)
  isActive  Boolean @default(true)
  isFree    Boolean @default(false)
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  module   Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress LessonProgress[]

  @@map("lessons")
}

// üìù MODELO DE INSCRIPCIONES
model Enrollment {
  id       String @id @default(cuid())
  userId   String
  courseId String
  
  // Estado
  status      String   @default("ACTIVE") // "ACTIVE", "COMPLETED", "CANCELLED"
  progress    Float    @default(0) // Porcentaje de progreso (0-100)
  completedAt DateTime?
  enrolledAt  DateTime @default(now()) // Fecha de inscripci√≥n
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  user   User   @relation(fields: [userId], references: [clerkId], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  // √çndice √∫nico para evitar inscripciones duplicadas
  @@unique([userId, courseId])
  @@map("enrollments")
}

// üìä MODELO DE PROGRESO DE LECCIONES
model LessonProgress {
  id       String @id @default(cuid())
  userId   String
  lessonId String
  
  // Progreso
  completed    Boolean   @default(false)
  watchTime    Int       @default(0) // Tiempo visto en segundos
  startedAt    DateTime  @default(now())
  completedAt  DateTime?
  
  // Metadata
  updatedAt DateTime @updatedAt

  // Relaciones
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  // √çndice √∫nico para evitar duplicados
  @@unique([userId, lessonId])
  @@map("lesson_progress")
}

// üóìÔ∏è MODELO DE TALLERES EN VIVO
model LiveWorkshop {
  id          String @id @default(cuid())
  title       String
  description String? @db.Text
  
  // Programaci√≥n
  scheduledAt DateTime
  duration    Int      // Duraci√≥n en minutos
  maxStudents Int      @default(50)
  
  // Estado
  status      String   @default("SCHEDULED") // "SCHEDULED", "LIVE", "COMPLETED", "CANCELLED"
  meetingUrl  String?  // URL de la reuni√≥n (Zoom, Meet, etc.)
  
  // Restricci√≥n de plan
  requiredPlan String  @default("PREMIUM") // "BASIC", "PREMIUM", "PREMIUM_PLUS"
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  registrations WorkshopRegistration[]

  @@map("live_workshops")
}

// üìù MODELO DE INSCRIPCIONES A TALLERES
model WorkshopRegistration {
  id          String @id @default(cuid())
  userId      String
  workshopId  String
  
  // Estado
  status      String   @default("REGISTERED") // "REGISTERED", "ATTENDED", "MISSED", "CANCELLED"
  registeredAt DateTime @default(now())
  
  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  user     User         @relation(fields: [userId], references: [clerkId], onDelete: Cascade)
  workshop LiveWorkshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)

  // √çndice √∫nico
  @@unique([userId, workshopId])
  @@map("workshop_registrations")
}

// üèÜ MODELO DE CERTIFICADOS (OPCIONAL)
model Certificate {
  id       String @id @default(cuid())
  userId   String
  courseId String
  
  // Informaci√≥n del certificado
  certificateNumber String  @unique
  issuedAt         DateTime @default(now())
  expiresAt        DateTime?
  
  // URL del certificado generado
  certificateUrl String?
  
  // Metadata
  createdAt DateTime @default(now())

  @@map("certificates")
}

// üí¨ MODELO DE COMENTARIOS/RESE√ëAS (OPCIONAL)
model Review {
  id       String @id @default(cuid())
  userId   String
  courseId String
  
  // Rese√±a
  rating  Int     // 1-5 estrellas
  comment String?
  
  // Estado
  isApproved Boolean @default(false)
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("reviews")
}
